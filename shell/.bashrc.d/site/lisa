#!/bin/bash

# If I have the LISA articles SVN repository checked out, set up environment.
if [ -e $HOME/src/articles ] ; then
    export BIBINPUTS=.:$HOME/src/articles/bib:
    export BSTINPUTS=.:$HOME/src/articles/bst:
    export TEXINPUTS=.:$HOME/src/articles/sty:
fi

# Only execute on DIRO department machines.
if [ `echo $HOSTNAME | cut -d '.' -f 2` == 'iro' ] ; then
    # LISA-specific .bashrc imports.
    if [ -e /opt/lisa/os_v4/.local.bashrc ] ; then
        source /opt/lisa/os_v4/.local.bashrc
#    elif [ -e /data/lisa/data/local_export/.local.bashrc ] ; then
#        source /data/lisa/data/local_export/.local.bashrc
    fi
    # I'd rather not use the PYTHONPATH, opting for my own conda installation.
    unset PYTHONPATH
    # Fred's up-to-date Firefox install. Use the directory that appears
	# alphabetically last, which hopefully should always be the most recent.
    if [ -d /opt/lisa/os ]; then
        FIREFOX_BIN=`/bin/ls -d /opt/lisa/os/firefox-* | tail -n 1`/bin
        if [ -e $FIREFOX_BIN ] ; then
            front_of_path $FIREFOX_BIN
        fi
    fi
    # LD_LIBRARY_PATH using ~/sw.
    export LD_LIBRARY_PATH="$HOME/sw/lib:$LD_LIBRARY_PATH"
    export PKG_CONFIG_PATH="$HOME/sw/lib/pkgconfig:$PKG_CONFIG_PATH"

    # Prevent tmux processes from being orphaned without Kerberos tickets
    # by attaching a "pkboost" process to every tmux session. This works by
    # checking on startup if $TMUX is defined, and if it is, starting a
    # pkboost instance pointed at this tmux session's PID if one isn't
    # already running. We maintain a pkboost.pid file containing (you guessed
    # it) the PID of the corresponding pkboost instance, inside the tmux
    # session directory.
    function run_tmux_pkboost() {
        CREDENTIALS=$(echo $KRB5CCNAME |cut -d':' -f 2)
        NEWTICKET=$(mktemp /tmp/krb5cc-tmux_XXXXXXXXXXXX)
        echo cp $CREDENTIALS $NEWTICKET
        cp $CREDENTIALS $NEWTICKET
        echo export KRB5CCNAME="FILE:$NEWTICKET"
        export KRB5CCNAME="FILE:$NEWTICKET"
        echo tmux set-environment -g KRB5CCNAME "FILE:$NEWTICKET"
        tmux set-environment -g KRB5CCNAME "FILE:$NEWTICKET"
        echo pkboost +d $2
        pkboost +d $2
        echo export TMUX_PKBOOST=$(pgrep -f "pkboost \+d $2")
        export TMUX_PKBOOST=$(pgrep -f "pkboost \+d $2")
        # echo echo $! >$1/pkboost.pid
        # echo $! >$1/pkboost.pid
        echo tmux set-environment -g TMUX_PKBOOST $TMUX_PKBOOST
        tmux set-environment -g TMUX_PKBOOST $TMUX_PKBOOST
    }

    if [ -n "$TMUX" ]; then
        TMUX_DIR=`dirname \`echo $TMUX |cut -d ',' -f 1\``
        TMUX_PID=`echo $TMUX |cut -d ',' -f 2`
        if [ -z "$TMUX_PKBOOST" ]; then
            run_tmux_pkboost $TMUX_DIR $TMUX_PID
        fi
    fi
fi
